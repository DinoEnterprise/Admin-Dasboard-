<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Web2App Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Outfit",sans-serif;}
body{display:flex;height:100vh;background:#0a0a0a;color:#fff;}
#sidebar{width:250px;background:#111;display:flex;flex-direction:column;transition:0.3s;}
#sidebar.collapsed{width:0;overflow:hidden;}
#sidebar input{margin:10px;padding:8px;border-radius:10px;border:none;outline:none;}
#userList{flex:1;overflow-y:auto;}
.userItem{padding:10px 12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;position:relative;}
.userItem.newMsg{background:#1f1f1f;font-weight:600;}
.userItem button{background:none;border:none;color:#f55;cursor:pointer;font-size:16px;}
#chatArea{flex:1;display:flex;flex-direction:column;background:#121212;}
#chatHeader{padding:12px;background:#1b1b1b;font-weight:600;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;}
#chatContainer{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.chat-bubble{padding:10px 14px;border-radius:16px;max-width:70%;line-height:1.4;}
.userBubble{background:#2563eb;color:#fff;align-self:flex-start;}
.adminBubble{background:#444;color:#fff;align-self:flex-end;}
#inputArea{display:flex;padding:10px;gap:8px;background:#1b1b1b;}
#inputArea input{flex:1;padding:8px;border-radius:12px;border:none;outline:none;}
#inputArea button{padding:8px 14px;border-radius:12px;border:none;background:#2563eb;color:#fff;cursor:pointer;}
.scrollbar::-webkit-scrollbar{width:8px;}
.scrollbar::-webkit-scrollbar-thumb{background:#333;border-radius:4px;}
.scrollbar::-webkit-scrollbar-track{background:transparent;}
#toggleSidebar{display:none;position:absolute;top:10px;left:10px;background:#2563eb;border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;z-index:10;}
@media(max-width:768px){
  #sidebar{position:absolute;height:100%;z-index:5;}
  #toggleSidebar{display:block;}
}
</style>
</head>
<body>

<button id="toggleSidebar">‚ò∞</button>

<div id="sidebar">
  <input type="text" id="searchUser" placeholder="Cari user...">
  <div id="userList" class="scrollbar"></div>
</div>

<div id="chatArea">
  <div id="chatHeader">Pilih user untuk chat</div>
  <div id="chatContainer" class="scrollbar"></div>
  <div id="inputArea">
    <input type="text" id="replyInput" placeholder="Ketik balasan...">
    <button onclick="sendReply()">Kirim</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAc_-F3iHn3gdpl2mqwT9uGgwL2pSipLW4",
  authDomain: "csbulan-997ea.firebaseapp.com",
  databaseURL: "https://csbulan-997ea-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "csbulan-997ea",
  storageBucket: "csbulan-997ea.appspot.com",
  messagingSenderId: "548129208386",
  appId: "1:548129208386:web:481ba552040813a39195db"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === Aktifkan izin notif untuk Web2App === */
Notification.requestPermission();

let selectedUser = null;
const chatContainer = document.getElementById('chatContainer');
const userListDiv = document.getElementById('userList');
const chatHeader = document.getElementById('chatHeader');
let messageRefs = {};
let hiddenMessages = [];
let usersData = {};

// Toggle sidebar mobile
const toggleBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar');
toggleBtn.addEventListener('click',()=>sidebar.classList.toggle('collapsed'));

// Add user to sidebar
function addUserToList(userId){
  if(document.getElementById('user-'+userId)) return;
  const div = document.createElement('div');
  div.id = 'user-'+userId;
  div.classList.add('userItem');
  div.innerHTML = `<span>${userId}</span><div>
                     <button onclick="deleteUser('${userId}');event.stopPropagation()">üóëÔ∏è</button>
                   </div>`;
  div.onclick = ()=>selectUser(userId);
  userListDiv.appendChild(div);
  usersData[userId] = div;
}

// Delete user
function deleteUser(userId){
  if(confirm(`Hapus user ${userId} beserta semua chatnya?`)){
    db.ref('chats/'+userId).remove();
    const div = document.getElementById('user-'+userId);
    if(div) div.remove();
    if(selectedUser === userId){
      selectedUser = null;
      chatContainer.innerHTML = '';
      chatHeader.innerText = 'Pilih user untuk chat';
    }
    delete usersData[userId];
  }
}

// Fetch all users
db.ref('chats').once('value', snapshot=>{
  snapshot.forEach(s=>addUserToList(s.key));
});

// Listen for new users
db.ref('chats').on('child_added', snapshot=>addUserToList(snapshot.key));

// Search user
document.getElementById('searchUser').addEventListener('input', e=>{
  const val = e.target.value.toLowerCase();
  for(let userId in usersData){
    usersData[userId].style.display = userId.toLowerCase().includes(val)?'flex':'none';
  }
});

// Select user & show chat
function selectUser(userId){
  selectedUser = userId;
  chatHeader.innerText = `Chat dengan: ${userId}`;
  chatContainer.innerHTML = '';
  usersData[userId].classList.remove('newMsg');

  if(messageRefs[userId]) messageRefs[userId].off();
  const ref = db.ref('chats/'+userId);
  messageRefs[userId] = ref;

  ref.on('child_added', snapshot=>{
    const data = snapshot.val();
    const id = snapshot.key;
    if(!data || hiddenMessages.includes(id)) return;

    const div = document.createElement('div');
    div.classList.add('chat-bubble', data.type==='user'?'userBubble':'adminBubble');
    div.innerText = data.message;

    // hapus pesan admin-side
    div.addEventListener('dblclick', ()=>{ hiddenMessages.push(id); div.remove(); });

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    /* === NOTIFIKASI UNTUK WEB2APP === */
    if(data.type==='user' && selectedUser !== userId){

      if(Notification.permission === "granted"){
        new Notification("Pesan baru", {
          body: data.message
        });
      }

      alert(`Pesan baru dari ${userId}: ${data.message}`);
      usersData[userId].classList.add('newMsg');
    }
  });
}

// Send reply
function sendReply(){
  if(!selectedUser) return;
  const msg = document.getElementById('replyInput').value.trim();
  if(!msg) return;
  db.ref('chats/'+selectedUser).push({message:msg,type:'admin',timestamp:Date.now()});
  document.getElementById('replyInput').value='';
}
</script>

</body>
</html>
