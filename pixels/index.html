<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - PX Music V5</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Outfit",sans-serif;}
body{display:flex;height:100vh;background:#0a0a0a;color:#fff;}
#sidebar{width:300px;background:#111;display:flex;flex-direction:column;transition:0.3s;}
#sidebar.collapsed{width:0;overflow:hidden;}
#sidebar input{margin:10px;padding:8px;border-radius:10px;border:none;outline:none;}
#userList{flex:1;overflow-y:auto;}
.userItem{padding:10px 12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;position:relative;}
.userItem.newMsg{background:#1f1f1f;font-weight:600;}
.userItem button{background:none;border:none;color:#f55;cursor:pointer;font-size:16px;margin-left:6px;}
#chatArea{flex:1;display:flex;flex-direction:column;background:#121212;}
#chatHeader{padding:12px;background:#1b1b1b;font-weight:600;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;}
#chatContainer{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.chat-bubble{padding:10px 14px;border-radius:16px;max-width:70%;line-height:1.4;}
.userBubble{background:#2563eb;color:#fff;align-self:flex-start;}
.adminBubble{background:#444;color:#fff;align-self:flex-end;}
.jobBubble{background:#3a3a3a;color:#fff;align-self:flex-start;border-left:3px solid #2563eb;padding-left:10px;}
#inputArea{display:flex;padding:10px;gap:8px;background:#1b1b1b;}
#inputArea input{flex:1;padding:8px;border-radius:12px;border:none;outline:none;}
#inputArea button{padding:8px 14px;border-radius:12px;border:none;background:#2563eb;color:#fff;cursor:pointer;}
.scrollbar::-webkit-scrollbar{width:8px;}
.scrollbar::-webkit-scrollbar-thumb{background:#333;border-radius:4px;}
.scrollbar::-webkit-scrollbar-track{background:transparent;}
#toggleSidebar{display:none;position:absolute;top:10px;left:10px;background:#2563eb;border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;z-index:10;}
@media(max-width:768px){
  #sidebar{position:absolute;height:100%;z-index:5;}
  #toggleSidebar{display:block;}
}
</style>
</head>
<body>

<button id="toggleSidebar">‚ò∞</button>

<div id="sidebar">
  <input type="text" id="searchUser" placeholder="Cari user...">
  <div id="userList" class="scrollbar"></div>
</div>

<div id="chatArea">
  <div id="chatHeader">Pilih user untuk lihat job & chat</div>
  <div id="chatContainer" class="scrollbar"></div>
  <div id="inputArea">
    <input type="text" id="replyInput" placeholder="Ketik balasan...">
    <button onclick="sendReply()">Kirim</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase config PX Music V5
const firebaseConfig = {
  apiKey: "AIzaSyAUoAi_LxYe-a4lgVqbYT2Aj9D0ITIkL2s",
  authDomain: "texttomusic-6ce7a.firebaseapp.com",
  databaseURL: "https://texttomusic-6ce7a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "texttomusic-6ce7a",
  storageBucket: "texttomusic-6ce7a.firebasestorage.app",
  messagingSenderId: "287856697988",
  appId: "1:287856697988:web:b87bf5c6632501d2b098d1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let selectedUser = null;
const chatContainer = document.getElementById('chatContainer');
const userListDiv = document.getElementById('userList');
const chatHeader = document.getElementById('chatHeader');
let messageRefs = {};
let hiddenMessages = [];
let usersData = {};

// Toggle sidebar mobile
document.getElementById('toggleSidebar').addEventListener('click', ()=>sidebar.classList.toggle('collapsed'));
const sidebar = document.getElementById('sidebar');

// Add user to sidebar
function addUserToList(userId){
  if(document.getElementById('user-'+userId)) return;
  const div = document.createElement('div');
  div.id = 'user-'+userId;
  div.classList.add('userItem');
  div.innerHTML = `<span>${userId}</span>
    <div>
      <button onclick="resetGenerate('${userId}');event.stopPropagation()">üîÑ</button>
      <button onclick="deleteUser('${userId}');event.stopPropagation()">üóëÔ∏è</button>
    </div>`;
  div.onclick = ()=>selectUser(userId);
  userListDiv.appendChild(div);
  usersData[userId] = div;
}

// Delete user
function deleteUser(userId){
  if(confirm(`Hapus user ${userId} beserta semua job & chat?`)){
    db.ref('jobs/'+userId).remove();
    db.ref('chats/'+userId).remove();
    const div = document.getElementById('user-'+userId);
    if(div) div.remove();
    if(selectedUser === userId){
      selectedUser = null;
      chatContainer.innerHTML = '';
      chatHeader.innerText = 'Pilih user untuk lihat job & chat';
    }
    delete usersData[userId];
  }
}

// Reset hak generate user
function resetGenerate(userId){
  if(confirm(`Reset hak generate untuk ${userId}?`)){
    db.ref('users/'+userId+'/hasGenerated').set(false);
    alert(`${userId} sekarang bisa generate lagi.`);
  }
}

// Fetch users dari jobs
db.ref('jobs').once('value', snapshot=>{
  snapshot.forEach(s=>addUserToList(s.key));
});

// Listen untuk user baru
db.ref('jobs').on('child_added', snapshot=>{
  addUserToList(snapshot.key);
});

// Search user
document.getElementById('searchUser').addEventListener('input', e=>{
  const val = e.target.value.toLowerCase();
  for(let userId in usersData){
    usersData[userId].style.display = userId.toLowerCase().includes(val)?'flex':'none';
  }
});

// Select user & tampilkan job + chat
function selectUser(userId){
  selectedUser = userId;
  chatHeader.innerText = `User: ${userId}`;
  chatContainer.innerHTML = '';
  usersData[userId].classList.remove('newMsg');

  // Tampilkan semua job user
  db.ref('jobs/'+userId).once('value', snapshot=>{
    snapshot.forEach(job=>{
      const data = job.val();
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble jobBubble';
      bubble.innerHTML = `
        <b>Judul:</b> ${data.judul || '-'}<br>
        <b>Style:</b> ${data.style || '-'}<br>
        <b>Gender:</b> ${data.gender || '-'}<br>
        <b>Status:</b> ${data.status || 'Memproses...'}
      `;
      chatContainer.appendChild(bubble);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  // Listen chat user
  if(messageRefs[userId]) messageRefs[userId].off();
  const ref = db.ref('chats/'+userId);
  messageRefs[userId] = ref;
  ref.on('child_added', snapshot=>{
    const data = snapshot.val();
    const id = snapshot.key;
    if(!data || hiddenMessages.includes(id)) return;

    const div = document.createElement('div');
    div.classList.add('chat-bubble', data.type==='user'?'userBubble':'adminBubble');
    div.innerText = data.message;

    div.addEventListener('dblclick', ()=>{ hiddenMessages.push(id); div.remove(); });

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    if(data.type==='user' && selectedUser !== userId){
      alert(`Pesan baru dari ${userId}: ${data.message}`);
      usersData[userId].classList.add('newMsg');
    }
  });
}

// Send reply
function sendReply(){
  if(!selectedUser) return;
  const msg = document.getElementById('replyInput').value.trim();
  if(!msg) return;
  db.ref('chats/'+selectedUser).push({message:msg,type:'admin',timestamp:Date.now()});
  document.getElementById('replyInput').value='';
}
</script>

</body>
</html>
