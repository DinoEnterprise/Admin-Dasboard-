<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - PX Music V5</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Outfit",sans-serif;}
body{display:flex;height:100vh;background:#0a0a0a;color:#fff;}
#sidebar{width:300px;background:#111;display:flex;flex-direction:column;transition:0.3s;}
#sidebar.collapsed{width:0;overflow:hidden;}
#sidebar input{margin:10px;padding:8px;border-radius:10px;border:none;outline:none;}
#userList{flex:1;overflow-y:auto;}
.userItem{padding:10px 12px;border-bottom:1px solid #222;cursor:pointer;display:flex;justify-content:space-between;align-items:center;position:relative;}
.userItem.newMsg{background:#1f1f1f;font-weight:600;}
.userItem button{background:none;border:none;color:#f55;cursor:pointer;font-size:16px;margin-left:6px;}
#chatArea{flex:1;display:flex;flex-direction:column;background:#121212;}
#chatHeader{padding:12px;background:#1b1b1b;font-weight:600;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;}
#chatContainer{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.chat-bubble{padding:10px 14px;border-radius:16px;max-width:70%;line-height:1.4;}
.userBubble{background:#2563eb;color:#fff;align-self:flex-start;}
.adminBubble{background:#444;color:#fff;align-self:flex-end;}
.jobBubble{background:#3a3a3a;color:#fff;align-self:flex-start;border-left:3px solid #2563eb;padding-left:10px;}
.lyricsBox{background:#222;padding:8px;margin:5px 0;border-radius:8px;max-height:120px;overflow-y:auto;white-space:pre-line;font-size:0.95rem;}
.copyBtn{margin-top:4px;padding:4px 8px;border:none;border-radius:6px;background:#2563eb;color:#fff;cursor:pointer;font-size:0.85rem;}
#inputArea{display:flex;padding:10px;gap:8px;background:#1b1b1b;}
#inputArea input{flex:1;padding:8px;border-radius:12px;border:none;outline:none;}
#inputArea button{padding:8px 14px;border-radius:12px;border:none;background:#2563eb;color:#fff;cursor:pointer;}
.scrollbar::-webkit-scrollbar{width:8px;}
.scrollbar::-webkit-scrollbar-thumb{background:#333;border-radius:4px;}
.scrollbar::-webkit-scrollbar-track{background:transparent;}
#toggleSidebar{display:none;position:absolute;top:10px;left:10px;background:#2563eb;border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;z-index:10;}
@media(max-width:768px){
  #sidebar{position:absolute;height:100%;z-index:5;}
  #toggleSidebar{display:block;}
}
</style>
</head>
<body>
<button id="toggleSidebar">‚ò∞</button>

<div id="sidebar">
  <input type="text" id="searchUser" placeholder="Cari user...">
  <div id="userList" class="scrollbar"></div>
</div>

<div id="chatArea">
  <div id="chatHeader">Pilih user untuk lihat job & chat</div>
  <div id="chatContainer" class="scrollbar"></div>
  <div id="inputArea">
    <input type="text" id="replyInput" placeholder="Ketik balasan...">
    <button onclick="sendReply()">Kirim</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyAUoAi_LxYe-a4lgVqbYT2Aj9D0ITIkL2s",
  authDomain: "texttomusic-6ce7a.firebaseapp.com",
  projectId: "texttomusic-6ce7a",
  storageBucket: "texttomusic-6ce7a.firebasestorage.app",
  messagingSenderId: "287856697988",
  appId: "1:287856697988:web:b87bf5c6632501d2b098d1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Variables =====
let selectedUser = null;
const chatContainer = document.getElementById('chatContainer');
const userListDiv = document.getElementById('userList');
const chatHeader = document.getElementById('chatHeader');
let messageUnsub = null;
let usersData = {};

// ===== Sidebar toggle =====
const sidebar = document.getElementById('sidebar');
document.getElementById('toggleSidebar').addEventListener('click', ()=>sidebar.classList.toggle('collapsed'));

// ===== User list =====
function addUserToList(userId){
  if(document.getElementById('user-'+userId)) return;
  const div = document.createElement('div');
  div.id = 'user-'+userId;
  div.classList.add('userItem');
  div.innerHTML = `<span>${userId}</span>
    <div>
      <button onclick="resetGenerate('${userId}');event.stopPropagation()">üîÑ</button>
      <button onclick="deleteUser('${userId}');event.stopPropagation()">üóëÔ∏è</button>
    </div>`;
  div.onclick = ()=>selectUser(userId);
  userListDiv.appendChild(div);
  usersData[userId] = div;
}

// ===== Delete user =====
function deleteUser(userId){
  if(confirm(`Hapus user ${userId} beserta semua job & chat?`)){
    db.collection('jobs').doc(userId).delete();
    db.collection('chats').doc(userId).delete();
    const div = document.getElementById('user-'+userId); if(div) div.remove();
    if(selectedUser === userId){ selectedUser=null; chatContainer.innerHTML=''; chatHeader.innerText='Pilih user untuk lihat job & chat'; }
    delete usersData[userId];
  }
}

// ===== Reset generate =====
function resetGenerate(userId){
  if(confirm(`Reset hak generate untuk ${userId}?`)){
    db.collection('users').doc(userId).set({hasGenerated:false},{merge:true});
    alert(`${userId} sekarang bisa generate lagi.`);
  }
}

// ===== Fetch users =====
db.collection('jobs').get().then(snapshot=>{
  snapshot.forEach(doc=> addUserToList(doc.id));
});

// ===== Listen user baru realtime =====
db.collection('jobs').onSnapshot(snapshot=>{
  snapshot.docChanges().forEach(change=>{
    if(change.type === 'added') addUserToList(change.doc.id);
  });
});

// ===== Search user =====
document.getElementById('searchUser').addEventListener('input', e=>{
  const val = e.target.value.toLowerCase();
  for(let userId in usersData){
    usersData[userId].style.display = userId.toLowerCase().includes(val)?'flex':'none';
  }
});

// ===== Select user =====
function selectUser(userId){
  selectedUser = userId;
  chatHeader.innerText = `User: ${userId}`;
  chatContainer.innerHTML='';
  usersData[userId].classList.remove('newMsg');

  // Tampilkan job user
  db.collection('jobs').doc(userId).get().then(doc=>{
    if(doc.exists){
      const data = doc.data();
      const bubble = document.createElement('div');
      bubble.className='chat-bubble jobBubble';
      bubble.innerHTML=`
        <b>Judul:</b> ${data.judul || '-'}<br>
        <b>Style:</b> ${data.style || '-'}<br>
        <b>Gender:</b> ${data.gender || '-'}<br>
        <b>Status:</b> ${data.status || 'Memproses...'}<br>
        <b>Job ID:</b> ${data.jobId || '-'}<br>
        <b>Lirik:</b>
        <div class="lyricsBox" id="lyrics-${data.jobId}">${data.lyrics || '-'}</div>
        <button class="copyBtn" onclick="copyLyrics('${data.jobId}')">Copy Lirik</button>
      `;
      chatContainer.appendChild(bubble);
    }
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });

  // Listen chat realtime
  if(messageUnsub) messageUnsub();
  messageUnsub = db.collection('chats').doc(userId).collection('messages')
    .orderBy('timestamp','asc')
    .onSnapshot(snapshot=>{
      snapshot.docChanges().forEach(change=>{
        if(change.type==='added'){
          const data = change.doc.data();
          const div = document.createElement('div');
          div.classList.add('chat-bubble', data.type==='user'?'userBubble':'adminBubble');
          div.innerText = data.message;
          chatContainer.appendChild(div);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      });
    });
}

// ===== Send reply =====
function sendReply(){
  if(!selectedUser) return;
  const msg = document.getElementById('replyInput').value.trim();
  if(!msg) return;
  db.collection('chats').doc(selectedUser).collection('messages').add({
    message: msg,
    type: 'admin',
    timestamp: Date.now()
  });
  document.getElementById('replyInput').value='';
}

// ===== Copy lirik =====
function copyLyrics(jobId){
  const lyricsDiv = document.getElementById(`lyrics-${jobId}`);
  if(lyricsDiv){
    navigator.clipboard.writeText(lyricsDiv.innerText).then(()=> alert('Lirik berhasil di-copy!'));
  }
}
</script>
</body>
</html>
