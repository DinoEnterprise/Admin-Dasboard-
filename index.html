<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Bulan Chat</title>
<style>
body{font-family:sans-serif;background:#111;color:#fff;margin:0;display:flex;}
#userList{width:200px;background:#222;overflow-y:auto;height:100vh;padding:10px;}
#chatArea{flex:1;display:flex;flex-direction:column;height:100vh;}
#chatContainer{flex:1;overflow-y:auto;padding:10px;}
.chat-bubble{padding:8px 12px;border-radius:12px;margin-bottom:6px;max-width:70%;position:relative;user-select:none;cursor:pointer;}
.userBubble{background:#2563eb;align-self:flex-start;color:#fff;}
.adminBubble{background:#444;align-self:flex-end;color:#fff;}
#inputArea{display:flex;padding:10px;gap:6px;background:#222;}
#inputArea input{flex:1;padding:6px;border-radius:12px;border:none;}
#inputArea button{padding:6px 12px;border-radius:12px;border:none;background:#2563eb;color:#fff;cursor:pointer;}
.userItem{padding:6px;border-bottom:1px solid #333;cursor:pointer;}
.userItem:hover{background:#333;}
</style>
</head>
<body>
<div id="userList"></div>
<div id="chatArea">
  <div id="chatContainer"></div>
  <div id="inputArea">
    <input type="text" id="replyInput" placeholder="Ketik balasan...">
    <button onclick="sendReply()">Kirim</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAc_-F3iHn3gdpl2mqwT9uGgwL2pSipLW4",
  authDomain: "csbulan-997ea.firebaseapp.com",
  databaseURL: "https://csbulan-997ea-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "csbulan-997ea",
  storageBucket: "csbulan-997ea.firebasestorage.app",
  messagingSenderId: "548129208386",
  appId: "1:548129208386:web:481ba552040813a39195db"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let selectedUser = null;
const chatContainer = document.getElementById('chatContainer');
const userListDiv = document.getElementById('userList');
let messageRefs = {};

// array untuk menyimpan ID pesan yang dihapus di admin saja
let hiddenMessages = [];

// Ambil semua user
db.ref('chats').on('child_added', snapshot=>{
  const userId = snapshot.key;
  if(!userId) return;
  const div = document.createElement('div');
  div.innerText = userId;
  div.classList.add('userItem');
  div.onclick = ()=>selectUser(userId);
  userListDiv.appendChild(div);
});

function selectUser(userId){
  selectedUser = userId;
  chatContainer.innerHTML = '';

  if(messageRefs[userId]) messageRefs[userId].off();
  const ref = db.ref('chats/'+userId);
  messageRefs[userId] = ref;

  ref.on('child_added', snapshot=>{
    const data = snapshot.val();
    const id = snapshot.key;
    if(!data) return;

    // jika pesan dihapus admin, skip
    if(hiddenMessages.includes(id)) return;

    const div = document.createElement('div');
    div.classList.add('chat-bubble', data.type==='user'?'userBubble':'adminBubble');
    div.innerText = data.message;

    // klik dua kali untuk hapus di dashboard admin saja
    div.addEventListener('dblclick', ()=>{
        hiddenMessages.push(id); // simpan ID pesan yang dihapus
        div.remove();
    });

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });
}

// Kirim pesan admin
function sendReply(){
  if(!selectedUser) return;
  const msg = document.getElementById('replyInput').value.trim();
  if(!msg) return;
  db.ref('chats/'+selectedUser).push({message:msg,type:'admin',timestamp:Date.now()});
  document.getElementById('replyInput').value='';
}
</script>
</body>
</html>
